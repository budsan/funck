<!doctype html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="stylesheet" href="css/bootstrap.css" >

	<link rel="stylesheet" href="lib/codemirror.css">
	<link rel="stylesheet" href="theme/bootstrap.css">
	<style>
	
	.container {
		width: 95%;
		margin-left:auto;
		margin-right:auto;
	}

	.player-div {
		margin-left:auto;
		margin-right:auto;
		margin-top:10px;
		margin-bottom:10px;
		width:900px;
		background-color: white;

		-webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(120, 120, 120, 0.6);
		-moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(120, 120, 120, 0.6);
		box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(120, 120, 120, 0.6);
	}

	audio {
		width: 100%;
		height: 30px;
	}

	.input-prepend {
		display: table;
		width: 100%;
	}

	.add-on.oneliner
	{
		display: table-cell;
		width: 50px;
		background-color: white;
	}

	.onliner-input
	{
		display: table-cell;
		width: 100%;
		border-left-style: none;
	}

	input[type="text"], select, .add-on, #fftfreq {
		font-family: monospace;
	}

	</style>
</head>
	<body>
		<div class="container well">
			<form onsubmit="return false;">
			<div class="input-prepend">
				<span class="oneliner add-on">Left</span>
				<input class="onliner-input input-block-level" id="oneliner" value="t * ((t&gt;&gt;12|t&gt;&gt;8)&amp;63&amp;t&gt;&gt;4)" type="text" placeholder="Put your oneliner here...">
			</div>
			<div class="input-prepend">
				<span class="oneliner add-on">Right</span>
				<input class="onliner-input input-block-level" id="oneliner2" type="text" placeholder="Leave this field empty for mono sound...">
			</div>

			<div class="span11" id="aux-container" style="display:block; width:99%; margin: 0px">
				<!--<textarea id="aux"></textarea> -->
			</div>

			<div style="display:table">
				<div class="input-prepend" style="display:table-cell">
					<input value="Generate" id="gen" type="submit" class="btn btn-primary">
				</div>
				<div class="input-prepend" style="display:table-cell">
					<span class="add-on">Duration</span>
					<input class="input-mini" id="duration" value="30" type="text" >
				</div>
				<div class="input-prepend" style="display:table-cell">
					<span class="add-on">Samplerate</span>
					<select class="input-small" name="samplerate" id="samplerate">
						<option>44100</option>
						<option>22050</option>
						<option>11025</option>
						<option selected="selected">8000</option>
					</select>
				</div>
				<div class="input-prepend" style="display:table-cell">
					<span class="add-on">Depth</span>
					<select class="input-large" name="depth" id="depth">
						<option value="fnorm">float normalized</option>
						<option value="fclamp">float (-1.0/1.0)</option>
						<option value="16bits">16bits (-32768/32767)</option>
						<option value="8bits" selected="selected">8 bits (-128/127)</option>
					</select>
				</div>
			</div>
			
			</form>
			<div class="player-div">
				<div style="position:relative">
					<span id="fftfreq" style="position:absolute;top:0px;padding:10px;"></span>
				</div>
				<canvas id="fft" width="900" height="200" onmousemove="showFrequency(event)" onmouseout="clearFrequency()"></canvas>
				<div id="player"></div>
			</div>
			<div class="container input-prepend">
				<span class="oneliner add-on">Permalink</span>
				<input class="onliner-input input-block-level" id="link" type="text" placeholder="hinthint: use this as an URL">
			</div>
			<span id="error"></span>
	</div>
<script src="lib/codemirror.js"></script>
<script src="mode/javascript/javascript.js"></script>

<script src="magic.js"></script>
<script src="codecs.js"></script>

<script>
function isFullScreen(cm) {
	return /\bCodeMirror-fullscreen\b/.test(cm.getWrapperElement().className);
}

function winHeight() {
	return window.innerHeight || (document.documentElement || document.body).clientHeight;
}

function setFullScreen(cm, full) {
	var wrap = cm.getWrapperElement();
	if (full) {
		wrap.className += " CodeMirror-fullscreen";
		wrap.style.height = winHeight() + "px";
		document.documentElement.style.overflow = "hidden";
	} else {
		wrap.className = wrap.className.replace(" CodeMirror-fullscreen", "");
		wrap.style.height = "";
		document.documentElement.style.overflow = "";
	}
	cm.refresh();
}

CodeMirror.on(window, "resize", function() {
	var showing = document.body.getElementsByClassName("CodeMirror-fullscreen")[0];
	if (!showing) return;
	showing.CodeMirror.getWrapperElement().style.height = winHeight() + "px";
});

var codeMirror = CodeMirror(document.getElementById("aux-container"), {
	lineNumbers: true,
	theme: "bootstrap",
	extraKeys: {
		"F11": function(cm) {
			setFullScreen(cm, !isFullScreen(cm));
		},
		"Esc": function(cm) {
			if (isFullScreen(cm)) setFullScreen(cm, false);
		}
	}
});

function utf8_to_b64( str ) {
    return window.btoa(encodeURIComponent( str ));
}

function b64_to_utf8( str ) {
    return decodeURIComponent(window.atob( str ));
}

function play() {
	//check if oneliner one is empty, but two filled
	if (document.getElementById("oneliner").value == "" && document.getElementById("oneliner2").value != "") {
		//copy string over
		document.getElementById("oneliner").value = document.getElementById("oneliner2").value;
		document.getElementById("oneliner2").value = "";
	}

	//create links
	var obj = getParams();
	document.getElementById("link").value = makeLink(obj);
	try {
		playDataURI(makeURL(obj));
		document.getElementById('error').innerText = "";
	} catch (err) {
		document.getElementById('error').innerText = ""+err;
		alert(err);					
		throw err;
	}
}

function readURL() {
	var idx = document.URL.indexOf('?');
	if (idx != -1) {
		var json = false;
		var tempParams = new Object();
		var parm = document.URL.substring(idx+1, document.URL.length);
		try {
			//COMPRESSED URL
			parm_aux = b64_to_utf8(decodeURIComponent(parm)).decode_lzw();
			tempParams = JSON.parse(parm_aux);
			json = true;
		}
		catch(ex) {}
		if (!json) {
			//UNCOMPRESSED URL
			var pairs = document.URL.substring(idx+1, document.URL.length).split('&');
			for (var i=0; i< pairs.length; i++) {
				var j = pairs[i].indexOf('=');
				var name = pairs[i].substring(0, j);
				var value = pairs[i].substring(j+1);
				if (name == "oneliner" || name == "oneliner2" || name == "aux") {
					value = decodeURIComponent(value);
				}
				tempParams[name] = value;
			}
		}
		
		return tempParams;
	}
}

function getParams() {
	var params = Object();
	params.oneliner   = document.getElementById('oneliner').value;
	params.oneliner2  = document.getElementById('oneliner2').value;
	params.aux        = codeMirror.getValue();

	params.duration   = document.getElementById('duration').value;
	params.duration   = (params.duration < 1.0) ? 1.0 : params.duration;
	document.getElementById('duration').value = params.duration;

	params.depth      = document.getElementById('depth').value;
	params.rate       = document.getElementById('samplerate').value;
	if      (params.rate <= 8000 ) params.rate = 8000;
	else if (params.rate <= 11025) params.rate = 11025;
	else if (params.rate <= 22050) params.rate = 22050;
	else                           params.rate = 44100;
	document.getElementById('samplerate').value = params.rate;

	return params;
}

function setParams(params) {
	var shouldPlay = false;
	if (params["rate"]) {
		if      (params.rate <= 8000 ) params.rate = 8000;
		else if (params.rate <= 11025) params.rate = 11025;
		else if (params.rate <= 22050) params.rate = 22050;
		else                           params.rate = 44100;
		document.getElementById('samplerate').value = params.rate;
	}
	if (params["depth"]) {
		document.getElementById("depth").value = params["depth"];
	}
	if (params["duration"]) {
		document.getElementById("duration").value = params["duration"];
	}
	if (params["oneliner"]) {
		document.getElementById("oneliner").value = params["oneliner"];
		shouldPlay = true;
	}
	if (params["oneliner2"]) {
		document.getElementById("oneliner2").value = params["oneliner2"];
		shouldPlay = true;
	}
	if (params["aux"]) {
		codeMirror.setValue(params["aux"]);
	}
	
	return shouldPlay;
}

function makeLink(obj) {
	var link;
	var idx = document.URL.indexOf('?');
	if (idx != -1) {
		link = document.URL.substring(0, idx);
	}
	else {
		link = document.URL;
	}

	obj_str = JSON.stringify(obj);
	obj_enc = obj_str.encode_lzw();
	obj_bin = utf8_to_b64(obj_enc);
	obj_url = encodeURIComponent(obj_bin);

	var parm = "";
	parm += "oneliner="    + encodeURIComponent(obj.oneliner);
	parm += "&oneliner2="  + encodeURIComponent(obj.oneliner2);
	parm += "&aux="        + encodeURIComponent(obj.aux);
	parm += "&duration="   + encodeURIComponent(obj.duration);
	parm += "&rate="       + encodeURIComponent(obj.rate);
	parm += "&depth="      + encodeURIComponent(obj.depth);

	if (obj_url.length < parm.length ) {
		parm = obj_url;
	}
	
	return link + "?" + parm;
}

var x = document.createElement('audio');
var hasAudio = (typeof(x.play) !== 'undefined');
if (!hasAudio) {
	alert("You don't seem to have a browser that supports audio. It's ok, you're not a bad person. But this app will now fail.");
}

document.getElementById("oneliner").focus();
document.getElementById("gen").onclick = function () {
	play();
};

params = readURL();
if (params) {
	var shouldPlay = setParams(params);
	if (shouldPlay) play();
}

</script>
</body>
</html>
